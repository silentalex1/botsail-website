<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EduBypass</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/all.min.css">
    <style>
        :root {
            --primary: #1E90FF;
            --primary-hover: #1C86EE;
            --accent: #4682B4;
            --accent-hover: #4169E1;
            --secondary: #6495ED;
            --secondary-hover: #5D8AA8;
            --tertiary: #87CEEB;
            --tertiary-hover: #B0C4DE;
            --text: #E6F0FA;
            --bg-dark: #0D1B2A;
            --bg-light: #1B263B;
            --glass-bg: rgba(13, 27, 42, 0.92);
            --shadow: 0 6px 25px rgba(0, 0, 0, 0.5);
            --glow: 0 0 10px rgba(30, 144, 255, 0.5);
            --navbar-bg: rgba(13, 27, 42, 0.96);
        }

        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            min-height: 100vh;
            font-family: 'Inter', sans-serif;
            color: var(--text);
            background: linear-gradient(160deg, var(--bg-dark), var(--bg-light));
            overflow-x: hidden;
            transition: background 0.8s ease;
        }

        .navbar {
            background: var(--navbar-bg);
            backdrop-filter: blur(12px);
            padding: 0.7rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: fixed;
            width: 100%;
            top: 0;
            z-index: 50;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.4);
        }

        .navbar-brand {
            font-size: clamp(1.1rem, 2vw, 1.3rem);
            font-weight: 600;
            color: var(--text);
            display: flex;
            align-items: center;
            gap: 0.4rem;
            margin-left: 0.8rem;
        }

        .nav-links {
            display: flex;
            gap: 0.6rem;
            margin-right: 0.8rem;
            flex-wrap: wrap;
        }

        .nav-links a {
            color: var(--text);
            text-decoration: none;
            font-size: clamp(0.85rem, 1.5vw, 0.95rem);
            padding: 0.3rem 0.8rem;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.06);
            transition: all 0.2s ease;
            display: inline-flex;
            align-items: center;
            gap: 0.3rem;
        }

        .nav-links a:hover {
            background: var(--primary);
            transform: translateY(-1px) scale(1.01);
            box-shadow: 0 1px 6px rgba(30, 144, 255, 0.3);
        }

        .container {
            position: relative;
            min-height: calc(100vh - 50px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 3;
            padding: 70px 1rem 1rem;
        }

        .input-card {
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            border-radius: 12px;
            padding: clamp(0.8rem, 2vw, 1.2rem);
            width: min(90%, 450px);
            box-shadow: var(--shadow);
            border: 1px solid rgba(255, 255, 255, 0.2);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .input-card:hover {
            transform: translateZ(15px) scale(1.01);
            box-shadow: 0 8px 30px rgba(30, 144, 255, 0.6);
        }

        .input-group {
            display: flex;
            flex-direction: column;
            gap: clamp(0.8rem, 2vw, 1.2rem);
            width: 100%;
        }

        .domain-input {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(30, 144, 255, 0.3);
            border-radius: 8px;
            padding: clamp(0.4rem, 1vw, 0.6rem) clamp(0.8rem, 1.5vw, 1rem);
            color: var(--text);
            font-size: clamp(0.85rem, 1.5vw, 0.95rem);
            outline: none;
            transition: all 0.2s ease;
            box-shadow: inset 0 1px 2px rgba(0, 0, 0, 0.1), var(--glow);
            width: 94%;
            margin-left: 3%;
            font-weight: 400;
        }

        .domain-input:focus {
            background: rgba(255, 255, 255, 0.2);
            box-shadow: var(--glow), inset 0 1px 2px rgba(30, 144, 255, 0.1);
            transform: scale(1.005);
            border-color: var(--primary-hover);
        }

        .domain-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
            font-weight: 300;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(90px, 1fr));
            gap: clamp(0.4rem, 1vw, 0.6rem);
            justify-content: center;
            width: 94%;
            margin-left: 3%;
        }

        .view-button, .history-button, .clear-button, .permission-button, .analyze-button, .security-button, .access-button, .fetch-button {
            background: var(--primary);
            border: none;
            border-radius: 8px;
            padding: clamp(0.3rem, 1vw, 0.5rem) clamp(0.6rem, 1.5vw, 0.8rem);
            color: white;
            font-weight: 500;
            font-size: clamp(0.75rem, 1.4vw, 0.85rem);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.3rem;
            transition: all 0.2s ease;
            box-shadow: 0 3px 10px rgba(30, 144, 255, 0.3);
        }

        .view-button:hover, .history-button:hover, .clear-button:hover, .permission-button:hover, .analyze-button:hover, .security-button:hover, .access-button:hover, .fetch-button:hover {
            transform: translateY(-1px) scale(1.01);
            box-shadow: 0 4px 12px rgba(30, 144, 255, 0.5);
        }

        .view-button:hover { background: var(--primary-hover); }
        .history-button:hover { background: var(--accent-hover); }
        .clear-button:hover { background: var(--tertiary-hover); }
        .permission-button:hover { background: var(--secondary-hover); }
        .analyze-button:hover { background: var(--secondary-hover); }
        .security-button:hover { background: var(--tertiary-hover); }
        .access-button:hover { background: var(--accent-hover); }
        .fetch-button:hover { background: var(--tertiary-hover); }

        .error-message {
            color: var(--primary);
            background: rgba(30, 144, 255, 0.2);
            padding: clamp(0.3rem, 1vw, 0.5rem);
            border-radius: 6px;
            text-align: center;
            opacity: 0;
            transition: opacity 0.3s ease;
            font-size: clamp(0.75rem, 1.4vw, 0.85rem);
            box-shadow: 0 1px 6px rgba(30, 144, 255, 0.3);
            width: 94%;
            margin-left: 3%;
        }

        .error-message.show {
            opacity: 1;
        }

        .history-panel {
            position: fixed;
            top: 50px;
            right: -250px;
            width: min(80%, 250px);
            height: calc(100% - 50px);
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            border-left: 1px solid rgba(255, 255, 255, 0.2);
            padding: clamp(0.6rem, 1.5vw, 0.8rem);
            transition: right 0.3s ease;
            overflow-y: auto;
            z-index: 40;
        }

        .history-panel.open {
            right: 0;
        }

        .history-item {
            background: rgba(255, 255, 255, 0.08);
            border-radius: 6px;
            padding: clamp(0.3rem, 1vw, 0.5rem);
            margin-bottom: 0.4rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .history-item:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: scale(1.01);
        }

        .history-item p {
            margin: 0;
            font-size: clamp(0.75rem, 1.4vw, 0.85rem);
            color: var(--text);
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .history-item .delete-btn {
            background: var(--tertiary);
            border: none;
            border-radius: 50%;
            width: clamp(16px, 2.5vw, 20px);
            height: clamp(16px, 2.5vw, 20px);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .history-item .delete-btn:hover {
            background: var(--secondary);
            transform: scale(1.05);
        }

        .background-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            background-size: cover;
            background-position: center;
            filter: blur(10px);
            opacity: 0.4;
            transition: background-image 0.8s ease, opacity 0.6s ease;
        }

        .suggestion-list {
            background: var(--glass-bg);
            border-radius: 6px;
            padding: clamp(0.3rem, 1vw, 0.5rem);
            max-height: 120px;
            overflow-y: auto;
            position: absolute;
            top: 100%;
            left: 3%;
            right: 3%;
            display: none;
            z-index: 20;
            box-shadow: var(--shadow);
        }

        .suggestion-item {
            padding: clamp(0.2rem, 0.6vw, 0.3rem);
            cursor: pointer;
            border-radius: 4px;
            transition: all 0.2s ease;
            font-size: clamp(0.75rem, 1.4vw, 0.85rem);
        }

        .suggestion-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(2px);
        }

        .permission-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 60;
        }

        .permission-modal.show {
            display: flex;
        }

        .modal-content {
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            border-radius: 12px;
            padding: clamp(0.8rem, 2vw, 1.2rem);
            width: min(90%, 350px);
            box-shadow: var(--shadow);
            text-align: center;
            transition: transform 0.3s ease;
        }

        .modal-content:hover {
            transform: translateZ(10px) scale(1.01);
        }

        .modal-content h2 {
            margin-top: 0;
            font-size: clamp(0.9rem, 1.8vw, 1.1rem);
            color: var(--text);
        }

        .modal-content p {
            font-size: clamp(0.75rem, 1.4vw, 0.85rem);
            color: var(--text);
            margin-bottom: 1rem;
            line-height: 1.3;
        }

        .modal-buttons {
            display: flex;
            gap: clamp(0.6rem, 1.5vw, 0.8rem);
            justify-content: center;
        }

        .modal-button {
            background: var(--primary);
            border: none;
            border-radius: 6px;
            padding: clamp(0.3rem, 1vw, 0.5rem) clamp(0.6rem, 1.5vw, 0.8rem);
            color: white;
            font-weight: 500;
            font-size: clamp(0.75rem, 1.4vw, 0.85rem);
            cursor: pointer;
            transition: all 0.2s ease;
            box-shadow: 0 3px 10px rgba(30, 144, 255, 0.3);
        }

        .modal-button.cancel {
            background: var(--tertiary);
        }

        .modal-button:hover {
            background: var(--primary-hover);
            transform: translateY(-1px) scale(1.01);
            box-shadow: 0 4px 12px rgba(30, 144, 255, 0.5);
        }

        .modal-button.cancel:hover {
            background: var(--secondary);
        }

        .analysis-panel {
            position: fixed;
            bottom: -300px;
            left: 0;
            width: 100%;
            height: min(40vh, 300px);
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            padding: clamp(0.6rem, 1.5vw, 0.8rem);
            transition: bottom 0.3s ease;
            z-index: 40;
            overflow-y: auto;
        }

        .analysis-panel.open {
            bottom: 0;
        }

        .analysis-content {
            color: var(--text);
            font-size: clamp(0.75rem, 1.4vw, 0.85rem);
        }

        .analysis-content h3 {
            margin-top: 0;
            font-size: clamp(0.9rem, 1.8vw, 1.1rem);
        }

        .analysis-content p {
            margin: 0.3rem 0;
            line-height: 1.3;
        }

        .security-panel {
            position: fixed;
            top: -300px;
            left: 0;
            width: 100%;
            height: min(40vh, 300px);
            background: var(--glass-bg);
            backdrop-filter: blur(15px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding: clamp(0.6rem, 1.5vw, 0.8rem);
            transition: top 0.3s ease;
            z-index: 40;
            overflow-y: auto;
        }

        .security-panel.open {
            top: 50px;
        }

        .security-content {
            color: var(--text);
            font-size: clamp(0.75rem, 1.4vw, 0.85rem);
        }

        .security-content h3 {
            margin-top: 0;
            font-size: clamp(0.9rem, 1.8vw, 1.1rem);
        }

        .security-content p {
            margin: 0.3rem 0;
            line-height: 1.3;
        }

        @media (max-width: 600px) {
            .navbar {
                flex-direction: column;
                padding: 0.4rem;
                gap: 0.4rem;
            }

            .nav-links {
                justify-content: center;
                margin-right: 0;
            }

            .input-card {
                padding: 0.6rem;
            }

            .action-buttons {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (min-width: 1200px) {
            .input-card {
                width: 500px;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="navbar-brand">
            <i class="fas fa-skull-crossbones"></i> EduBypass
        </div>
        <div class="nav-links">
            <a href="/cheats"><i class="fas fa-code"></i> Cheats</a>
            <a href="/about"><i class="fas fa-info-circle"></i> About</a>
            <a href="/contact"><i class="fas fa-envelope"></i> Contact</a>
        </div>
    </nav>
    <div class="background-overlay" id="backgroundOverlay"></div>
    <div class="container">
        <div class="input-card">
            <div class="input-group">
                <div style="position: relative; width: 100%; display: flex; justify-content: center;">
                    <input type="text" class="domain-input" id="domainInput" placeholder="Enter any domain...">
                    <div class="suggestion-list" id="suggestionList"></div>
                </div>
                <div class="action-buttons">
                    <button class="view-button" id="viewButton"><i class="fas fa-globe"></i> View</button>
                    <button class="history-button" id="historyButton"><i class="fas fa-history"></i> History</button>
                    <button class="clear-button" id="clearButton"><i class="fas fa-trash"></i> Clear</button>
                    <button class="permission-button" id="permissionButton"><i class="fas fa-shield-alt"></i> Permission</button>
                    <button class="analyze-button" id="analyzeButton"><i class="fas fa-chart-line"></i> Analyze</button>
                    <button class="security-button" id="securityButton"><i class="fas fa-lock"></i> Security</button>
                    <button class="access-button" id="accessButton"><i class="fas fa-key"></i> Access</button>
                    <button class="fetch-button" id="fetchButton"><i class="fas fa-download"></i> Fetch Code</button>
                </div>
                <div class="error-message" id="errorMessage"></div>
            </div>
        </div>
    </div>
    <div class="history-panel" id="historyPanel">
        <h3>Recent Domains</h3>
        <div id="historyList"></div>
    </div>
    <div class="permission-modal" id="permissionModal">
        <div class="modal-content">
            <h2>Request Full Permissions</h2>
            <p>Granting permissions enables advanced features. Confirm to proceed?</p>
            <div class="modal-buttons">
                <button class="modal-button" id="grantPermission">Grant</button>
                <button class="modal-button cancel" id="cancelPermission">Cancel</button>
            </div>
        </div>
    </div>
    <div class="analysis-panel" id="analysisPanel">
        <div class="analysis-content" id="analysisContent">
            <h3>Website Analysis</h3>
            <p>Enter a domain to evaluate safety.</p>
        </div>
    </div>
    <div class="security-panel" id="securityPanel">
        <div class="security-content" id="securityContent">
            <h3>Security Scan</h3>
            <p>Enter a domain to check vulnerabilities.</p>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script>
        class WebViewer {
            constructor() {
                this.domainInput = document.getElementById('domainInput');
                this.viewButton = document.getElementById('viewButton');
                this.historyButton = document.getElementById('historyButton');
                this.clearButton = document.getElementById('clearButton');
                this.permissionButton = document.getElementById('permissionButton');
                this.analyzeButton = document.getElementById('analyzeButton');
                this.securityButton = document.getElementById('securityButton');
                this.accessButton = document.getElementById('accessButton');
                this.fetchButton = document.getElementById('fetchButton');
                this.errorMessage = document.getElementById('errorMessage');
                this.backgroundOverlay = document.getElementById('backgroundOverlay');
                this.historyPanel = document.getElementById('historyPanel');
                this.historyList = document.getElementById('historyList');
                this.suggestionList = document.getElementById('suggestionList');
                this.permissionModal = document.getElementById('permissionModal');
                this.grantPermission = document.getElementById('grantPermission');
                this.cancelPermission = document.getElementById('cancelPermission');
                this.analysisPanel = document.getElementById('analysisPanel');
                this.analysisContent = document.getElementById('analysisContent');
                this.securityPanel = document.getElementById('securityPanel');
                this.securityContent = document.getElementById('securityContent');
                this.validUrlRegex = /^(https?:\/\/)?([\w-]+\.)+[\w-]+(\/[\w-./?%&=]*)?$/i;
                this.history = JSON.parse(localStorage.getItem('domainHistory')) || [];
                this.suggestions = ['example.com', 'google.com', 'github.com', 'wikipedia.org', 'x.com', 'youtube.com', 'reddit.com', 'stackoverflow.com', 'facebook.com', 'amazon.com'];
                this.permissionsGranted = false;
                this.proxyChain = [
                    { url: 'https://corsproxy.io/?', headers: { 'X-Origin-Auth': btoa('secure1' + Date.now()), 'X-Proxy-Key': this.generateKey(16), 'Cache-Control': 'no-store', 'X-Proxy-Layer': 'primary', 'X-Region': 'us-east-1' }, weight: 0.35, timeout: 6000, region: 'us-east', fallback: true, retryCount: 3, latency: 50, bandwidth: 1000 },
                    { url: 'https://api.allorigins.win/raw?url=', headers: { 'X-Custom-Token': btoa('secure2' + Math.random()), 'X-Proxy-Key': this.generateKey(16), 'Cache-Control': 'no-store', 'X-Proxy-Layer': 'secondary', 'X-Region': 'eu-west-2' }, weight: 0.30, timeout: 5500, region: 'eu-west', fallback: true, retryCount: 3, latency: 45, bandwidth: 1200 },
                    { url: 'https://proxy.custom/api/v1/', headers: { 'X-Session-Id': btoa(Date.now() + Math.random()), 'X-Proxy-Key': this.generateKey(16), 'Cache-Control': 'no-store', 'X-Proxy-Layer': 'tertiary', 'X-Region': 'ap-southeast-1' }, weight: 0.25, timeout: 5000, region: 'asia', fallback: false, retryCount: 2, latency: 40, bandwidth: 1500 },
                    { url: 'https://mirrorproxy.net/process?', headers: { 'X-Secure-Token': btoa('secure4' + Date.now()), 'X-Proxy-Key': this.generateKey(16), 'Cache-Control': 'no-store', 'X-Proxy-Layer': 'quaternary', 'X-Region': 'ca-central-1' }, weight: 0.10, timeout: 4500, region: 'ca-central', fallback: true, retryCount: 2, latency: 35, bandwidth: 1800 }
                ];
                this.encryptionKey = this.generateEncryptionKey();
                this.sessionTokens = new Map();
                this.proxyPerformance = new Map();
                this.connectionPool = new Map();
                this.initEventListeners();
                this.initAnimations();
                this.renderHistory();
            }

            generateKey(length) {
                const chars = 'ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789!@#$%^&*';
                let key = '';
                for (let i = 0; i < length; i++) {
                    key += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                return btoa(key);
            }

            generateEncryptionKey() {
                const timestamp = Date.now().toString(36);
                const randomStr = Array.from({length: 12}, () => Math.random().toString(36).charAt(2)).join('');
                const userAgentHash = btoa(navigator.userAgent.slice(0, 50) + Math.random());
                return btoa(`${timestamp}${randomStr}${userAgentHash}`);
            }

            initEventListeners() {
                this.viewButton.addEventListener('click', () => this.handleViewWebsite());
                this.historyButton.addEventListener('click', () => this.toggleHistoryPanel());
                this.clearButton.addEventListener('click', () => this.clearInput());
                this.permissionButton.addEventListener('click', () => this.showPermissionModal());
                this.analyzeButton.addEventListener('click', () => this.handleAnalyzeWebsite());
                this.securityButton.addEventListener('click', () => this.handleSecurityScan());
                this.accessButton.addEventListener('click', () => this.handleAccessWebsite());
                this.fetchButton.addEventListener('click', () => this.handleFetchCode());
                this.grantPermission.addEventListener('click', () => this.handleGrantPermission());
                this.cancelPermission.addEventListener('click', () => this.hidePermissionModal());
                this.domainInput.addEventListener('input', this.debounce(() => {
                    this.updateBackground();
                    this.updateSuggestions();
                }, 100));
                this.domainInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') this.handleAccessWebsite();
                });
                this.domainInput.addEventListener('focus', () => this.showSuggestions());
                this.domainInput.addEventListener('blur', () => setTimeout(() => this.hideSuggestions(), 150));
                this.suggestionList.addEventListener('click', (e) => {
                    const suggestion = e.target.closest('.suggestion-item')?.dataset.value;
                    if (suggestion) {
                        this.domainInput.value = suggestion;
                        this.handleAccessWebsite();
                    }
                });
                this.historyList.addEventListener('click', (e) => {
                    const domain = e.target.closest('.history-item')?.dataset.domain;
                    const deleteBtn = e.target.closest('.delete-btn');
                    if (deleteBtn) {
                        this.deleteHistoryItem(domain);
                    } else if (domain) {
                        this.domainInput.value = domain;
                        this.handleAccessWebsite();
                    }
                });
            }

            initAnimations() {
                gsap.from('.navbar', { duration: 0.7, y: -40, opacity: 0, ease: 'power2.out' });
                gsap.from('.input-card', { duration: 0.9, y: 40, opacity: 0, ease: 'power2.out' });
                gsap.from('.domain-input', { duration: 0.7, delay: 0.1, x: -40, opacity: 0, ease: 'power2.out' });
                gsap.from('.action-buttons', { duration: 0.7, delay: 0.2, x: 40, opacity: 0, ease: 'power2.out' });
            }

            debounce(func, wait) {
                let timeout;
                return (...args) => {
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func(...args), wait);
                };
            }

            updateBackground() {
                const domain = this.sanitizeDomain(this.domainInput.value);
                if (!domain) {
                    this.backgroundOverlay.style.backgroundImage = 'none';
                    gsap.to(this.backgroundOverlay, { opacity: 0.4, duration: 0.8, ease: 'power2.inOut' });
                    return;
                }
                try {
                    const favicon = `https://www.google.com/s2/favicons?domain=${domain}&sz=64`;
                    this.backgroundOverlay.style.backgroundImage = `url(${favicon})`;
                    gsap.to(this.backgroundOverlay, { opacity: 0.6, duration: 0.8, ease: 'power2.inOut' });
                } catch {
                    this.backgroundOverlay.style.backgroundImage = 'none';
                }
            }

            updateSuggestions() {
                const input = this.domainInput.value.toLowerCase();
                const filtered = this.suggestions.filter(s => s.includes(input) && s !== input);
                this.suggestionList.innerHTML = filtered.map(s => `<div class="suggestion-item" data-value="${s}">${s}</div>`).join('');
                this.suggestionList.style.display = filtered.length > 0 && input ? 'block' : 'none';
            }

            showSuggestions() { this.updateSuggestions(); }
            hideSuggestions() { this.suggestionList.style.display = 'none'; }

            sanitizeDomain(input) {
                let domain = input.trim().toLowerCase().replace(/[^a-z0-9.-]/g, '');
                if (!domain.startsWith('http')) domain = `https://${domain}`;
                return this.validUrlRegex.test(domain) ? domain.replace(/^https?:\/\//, '') : '';
            }

            showError(message) {
                this.errorMessage.textContent = message;
                this.errorMessage.classList.add('show');
                gsap.to(this.errorMessage, { opacity: 1, duration: 0.3, ease: 'power2.out' });
                setTimeout(() => {
                    gsap.to(this.errorMessage, { opacity: 0, duration: 0.3, ease: 'power2.in', onComplete: () => this.errorMessage.classList.remove('show') });
                }, 2500);
            }

            toggleHistoryPanel() {
                this.historyPanel.classList.toggle('open');
                gsap.to(this.historyPanel, { right: this.historyPanel.classList.contains('open') ? 0 : -250, duration: 0.3, ease: 'power2.inOut' });
            }

            renderHistory() {
                this.historyList.innerHTML = this.history.slice(0, 10).map(domain => `
                    <div class="history-item" data-domain="${domain}">
                        <p>${domain}</p>
                        <button class="delete-btn"><i class="fas fa-times"></i></button>
                    </div>
                `).join('');
            }

            saveToHistory(domain) {
                if (!this.history.includes(domain)) {
                    this.history.unshift(domain);
                    this.history = this.history.slice(0, 50);
                    localStorage.setItem('domainHistory', JSON.stringify(this.history));
                    this.renderHistory();
                }
            }

            deleteHistoryItem(domain) {
                this.history = this.history.filter(d => d !== domain);
                localStorage.setItem('domainHistory', JSON.stringify(this.history));
                this.renderHistory();
            }

            clearInput() {
                this.domainInput.value = '';
                this.updateBackground();
                this.hideSuggestions();
                gsap.to(this.domainInput, { scale: 0.98, duration: 0.15, ease: 'power2.in', yoyo: true, repeat: 1 });
            }

            showPermissionModal() {
                this.permissionModal.classList.add('show');
                gsap.from(this.permissionModal.querySelector('.modal-content'), { scale: 0.95, opacity: 0, duration: 0.3, ease: 'power2.out' });
            }

            hidePermissionModal() {
                gsap.to(this.permissionModal.querySelector('.modal-content'), { scale: 0.95, opacity: 0, duration: 0.3, ease: 'power2.in', onComplete: () => this.permissionModal.classList.remove('show') });
            }

            handleGrantPermission() {
                if ('clipboard' in navigator && 'geolocation' in navigator) {
                    this.permissionsGranted = true;
                    this.hidePermissionModal();
                    this.showError('Permissions granted! Additional confirmation required.');
                    this.showAdvancedPermissionModal();
                } else {
                    this.showError('Permissions not supported.');
                }
            }

            showAdvancedPermissionModal() {
                const advancedModal = document.createElement('div');
                advancedModal.className = 'permission-modal advanced-modal';
                advancedModal.innerHTML = `
                    <div class="modal-content">
                        <h2>Advanced Permissions</h2>
                        <p>Allow advanced features like real-time analytics and automated actions? Confirm again.</p>
                        <div class="modal-buttons">
                            <button class="modal-button" id="confirmAdvanced">Confirm</button>
                            <button class="modal-button cancel" id="declineAdvanced">Decline</button>
                        </div>
                    </div>
                `;
                document.body.appendChild(advancedModal);
                document.getElementById('confirmAdvanced').addEventListener('click', () => {
                    this.permissionsGranted = true;
                    document.body.style.background = 'linear-gradient(160deg, #1B263B, #0D1B2A)';
                    this.showError('Permissions fully granted!');
                    advancedModal.remove();
                });
                document.getElementById('declineAdvanced').addEventListener('click', () => {
                    this.permissionsGranted = false;
                    this.showError('Permissions declined.');
                    advancedModal.remove();
                });
                gsap.from(advancedModal.querySelector('.modal-content'), { scale: 0.95, opacity: 0, duration: 0.3, ease: 'power2.out' });
            }

            selectProxy(domain) {
                const domainHash = btoa(domain + this.generateKey(8)).slice(0, 12);
                const geoWeight = this.calculateGeoWeight();
                const perfWeight = this.calculatePerformanceWeight();
                const weightedProxies = this.proxyChain.map(proxy => {
                    const baseScore = proxy.weight * (1 + (proxy.bandwidth / 2000));
                    const geoScore = proxy.region === geoWeight.region ? 0.25 : 0.05;
                    const perfScore = this.proxyPerformance.get(proxy.url) || 0;
                    const latencyFactor = 1 - (proxy.latency / 100);
                    return { ...proxy, score: (baseScore + geoScore + perfScore) * latencyFactor };
                });
                const totalScore = weightedProxies.reduce((sum, proxy) => sum + proxy.score, 0);
                let random = Math.random() * totalScore;
                for (let proxy of weightedProxies) {
                    random -= proxy.score;
                    if (random <= 0) {
                        this.sessionTokens.set(domainHash, this.generateSessionToken(proxy.url));
                        return proxy;
                    }
                }
                return weightedProxies[0];
            }

            calculateGeoWeight() {
                const regions = ['us-east-1', 'eu-west-2', 'ap-southeast-1', 'ca-central-1'];
                return { region: regions[Math.floor(Math.random() * regions.length)], weight: 0.25 };
            }

            calculatePerformanceWeight() {
                return Array.from(this.proxyPerformance.entries()).reduce((acc, [url, perf]) => acc + perf, 0) / (this.proxyPerformance.size || 1) * 0.5;
            }

            generateSessionToken(proxyUrl) {
                const timestamp = Date.now().toString(36);
                const randomStr = Array.from({length: 10}, () => Math.random().toString(36).charAt(2)).join('');
                const proxyHash = btoa(proxyUrl + Math.random()).slice(0, 12);
                return btoa(`${timestamp}${randomStr}${proxyHash}`);
            }

            fetchWithTimeout(url, options, timeout) {
                return new Promise((resolve, reject) => {
                    const controller = new AbortController();
                    const id = setTimeout(() => controller.abort(), timeout);
                    fetch(url, { ...options, signal: controller.signal, credentials: 'omit', cache: 'no-store' }).then(response => {
                        const proxyUrl = new URL(url).origin;
                        const currentPerf = this.proxyPerformance.get(proxyUrl) || 0;
                        this.proxyPerformance.set(proxyUrl, currentPerf + (response.ok ? 0.15 : -0.15));
                        resolve(response);
                    }).catch(err => {
                        const proxyUrl = new URL(url).origin;
                        const currentPerf = this.proxyPerformance.get(proxyUrl) || 0;
                        this.proxyPerformance.set(proxyUrl, currentPerf - 0.25);
                        reject(err);
                    }).finally(() => clearTimeout(id));
                });
            }

            createIframe(windowRef, url) {
                const iframe = windowRef.document.createElement('iframe');
                Object.assign(iframe.style, {
                    position: 'fixed', width: '100vw', height: '100vh', top: 0, left: 0, zIndex: 2147483647,
                    backgroundColor: '#0D1B2A', border: 'none', transition: 'opacity 0.3s ease'
                });
                iframe.src = url;
                iframe.style.opacity = '0';
                return iframe;
            }

            verifyIframeLoad(iframe) {
                return new Promise((resolve, reject) => {
                    iframe.onload = () => gsap.to(iframe, { opacity: 1, duration: 0.3, ease: 'power2.out', onComplete: resolve });
                    iframe.onerror = () => reject(new Error('Failed to load'));
                    setTimeout(() => reject(new Error('Load timeout')), 8000);
                });
            }

            handleViewWebsite() {
                const domain = this.sanitizeDomain(this.domainInput.value);
                if (!domain) return this.showError('Enter a valid domain.');
                const url = `https://${domain}`;
                const newWindow = window.open('about:blank', '_blank', 'width=1000,height=700');
                if (!newWindow) return this.showError('Pop-up blocked.');
                const iframe = this.createIframe(newWindow, url);
                newWindow.document.body.appendChild(iframe);
                this.verifyIframeLoad(iframe).then(() => {
                    this.saveToHistory(domain);
                    gsap.to(this.viewButton, { scale: 0.94, duration: 0.15, yoyo: true, repeat: 1 });
                    if (this.permissionsGranted) {
                        navigator.clipboard.writeText(url);
                        navigator.geolocation.getCurrentPosition(pos => this.showError(`Location: ${pos.coords.latitude}, ${pos.coords.longitude}`));
                    }
                }).catch(e => this.showError(`View failed: ${e.message}`));
            }

            handleAnalyzeWebsite() {
                const domain = this.sanitizeDomain(this.domainInput.value);
                if (!domain) return this.showError('Enter a valid domain.');
                this.analysisPanel.classList.add('open');
                gsap.to(this.analysisPanel, { bottom: 0, duration: 0.3, ease: 'power2.inOut' });
                this.analysisContent.innerHTML = '<h3>Analyzing...</h3><p>Performing safety evaluation...</p>';
                const proxy = this.selectProxy(domain);
                const sessionToken = this.sessionTokens.get(btoa(domain + this.generateKey(6)).slice(0, 12));
                const headers = { ...proxy.headers, 'X-Session-Token': sessionToken, 'X-Timestamp': Date.now().toString(), 'X-Nonce': this.generateKey(8) };
                this.fetchWithTimeout(`${proxy.url}${encodeURIComponent(`https://${domain}`)}`, { mode: 'cors', headers }, proxy.timeout)
                    .then(r => r.text()).then(data => {
                        const doc = new DOMParser().parseFromString(data, 'text/html');
                        const title = doc.querySelector('title')?.textContent || 'No title';
                        const metaDesc = doc.querySelector('meta[name="description"]')?.content || 'No description';
                        const links = doc.querySelectorAll('a').length;
                        const scripts = doc.querySelectorAll('script').length;
                        const images = doc.querySelectorAll('img').length;
                        const trackers = ['google-analytics', 'facebook', 'doubleclick', 'hotjar'].filter(t => data.toLowerCase().includes(t)).length;
                        const suspicious = ['eval(', 'document.write', 'onerror', 'javascript:', 'setTimeout'].some(k => data.includes(k));
                        const externalResources = Array.from(doc.querySelectorAll('link, script[src], img[src]'))
                            .filter(el => el.src && !el.src.includes(domain) && !el.href?.includes(domain)).length;
                        const safetyScore = Math.min(100, 100 - (scripts * 2 + (links > 50 ? 15 : 0) + (images > 30 ? 12 : 0) + (trackers * 8) + (suspicious ? 20 : 0) + (externalResources * 3) - 30));
                        const safetyStatus = safetyScore > 70 ? 'Safe' : safetyScore > 40 ? 'Caution' : 'Risky';
                        this.analysisContent.innerHTML = `
                            <h3>${domain}</h3>
                            <p>Title: ${title}</p>
                            <p>Description: ${metaDesc}</p>
                            <p>Links: ${links}</p>
                            <p>Scripts: ${scripts}</p>
                            <p>Images: ${images}</p>
                            <p>Trackers: ${trackers}</p>
                            <p>External Resources: ${externalResources}</p>
                            <p>Suspicious Code: ${suspicious ? 'Detected' : 'None'}</p>
                            <p>Safety Score: ${safetyScore}% - ${safetyStatus}</p>
                        `;
                        if (safetyScore <= 70) this.showError(`${safetyStatus} detected. Proceed with caution.`);
                    }).catch(e => {
                        this.analysisContent.innerHTML = `<h3>Analysis Failed</h3><p>${e.message}</p>`;
                        this.showError('Analysis failed. Try again.');
                    });
            }

            handleSecurityScan() {
                const domain = this.sanitizeDomain(this.domainInput.value);
                if (!domain) return this.showError('Enter a valid domain.');
                this.securityPanel.classList.add('open');
                gsap.to(this.securityPanel, { top: 50, duration: 0.3, ease: 'power2.inOut' });
                this.securityContent.innerHTML = '<h3>Scanning...</h3><p>Conducting vulnerability assessment...</p>';
                const proxy = this.selectProxy(domain);
                const sessionToken = this.sessionTokens.get(btoa(domain + this.generateKey(6)).slice(0, 12));
                const headers = { ...proxy.headers, 'X-Session-Token': sessionToken, 'X-Timestamp': Date.now().toString(), 'X-Nonce': this.generateKey(8) };
                this.fetchWithTimeout(`${proxy.url}${encodeURIComponent(`https://${domain}`)}`, { mode: 'cors', headers }, proxy.timeout)
                    .then(r => r.text()).then(data => {
                        const doc = new DOMParser().parseFromString(data, 'text/html');
                        const forms = doc.querySelectorAll('form').length;
                        const inputs = doc.querySelectorAll('input').length;
                        const externalScripts = Array.from(doc.querySelectorAll('script[src]')).filter(s => !s.src.includes(domain)).length;
                        const iframes = doc.querySelectorAll('iframe').length;
                        const cookies = document.cookie.split(';').length;
                        const csp = doc.querySelector('meta[http-equiv="Content-Security-Policy"]')?.content || 'Not defined';
                        const xssPotential = data.includes('<script') && !csp.includes('script-src') && data.includes('onload');
                        const sqlInjectionRisk = data.includes('input') && !csp.includes('form-action');
                        const securityScore = Math.min(100, 100 - (forms * 6 + inputs * 4 + externalScripts * 7 + iframes * 5 + (cookies > 5 ? 15 : 0) + (xssPotential ? 20 : 0) + (sqlInjectionRisk ? 25 : 0) - (csp !== 'Not defined' ? 25 : 0) - 30));
                        this.securityContent.innerHTML = `
                            <h3>${domain}</h3>
                            <p>HTTPS: Yes</p>
                            <p>Forms: ${forms}</p>
                            <p>Inputs: ${inputs}</p>
                            <p>External Scripts: ${externalScripts}</p>
                            <p>Iframes: ${iframes}</p>
                            <p>Cookies: ${cookies}</p>
                            <p>CSP: ${csp.slice(0, 50)}</p>
                            <p>XSS Potential: ${xssPotential ? 'High' : 'Low'}</p>
                            <p>SQL Injection Risk: ${sqlInjectionRisk ? 'High' : 'Low'}</p>
                            <p>Security Score: ${securityScore}%</p>
                        `;
                        if (securityScore < 75) this.showError('Vulnerabilities detected. Enhance security measures.');
                    }).catch(e => {
                        this.securityContent.innerHTML = `<h3>Scan Failed</h3><p>${e.message}</p>`;
                        this.showError('Security scan failed. Retry.');
                    });
            }

            handleAccessWebsite() {
                const domain = this.sanitizeDomain(this.domainInput.value);
                if (!domain) return this.showError('Enter a valid domain.');
                const proxy = this.selectProxy(domain);
                const sessionToken = this.sessionTokens.get(btoa(domain + this.generateKey(6)).slice(0, 12));
                const timestamp = Date.now().toString(36);
                const nonce = btoa(Array.from({length: 8}, () => Math.random().toString(36).charAt(2)).join(''));
                const sessionId = btoa(Array.from({length: 10}, () => Math.random().toString(36).charAt(2)).join(''));
                const encodedDomain = btoa(domain.split('').reverse().join('') + this.generateKey(4));
                const obfuscated = this.xorEncrypt(encodedDomain, this.encryptionKey + nonce + sessionId + timestamp);
                const dynamicPorts = [8080, 8443, 9443, 2053, 2083, 3000, 4000];
                const port = dynamicPorts[Math.floor(Math.random() * dynamicPorts.length)];
                const randomSub = `x${Array.from({length: 6}, () => Math.random().toString(36).charAt(2)).join('')}`;
                const pathLayer1 = `/v${Math.floor(Math.random() * 10000)}/p${Math.floor(Math.random() * 9999)}/s${Math.random().toString(36).substr(2, 4)}`;
                const pathLayer2 = `/r${btoa(Math.random().toString(36) + Date.now()).replace(/=/g, '')}/t${Math.random().toString(36).substr(2, 6)}`;
                const pathLayer3 = `/e${Array.from({length: 5}, () => Math.random().toString(36).charAt(2)).join('')}`;
                const queryParams = new URLSearchParams({
                    nonce: nonce,
                    t: timestamp,
                    port: port,
                    sub: randomSub,
                    sid: sessionId,
                    hash: btoa(Math.random().toString(36) + Date.now()).replace(/=/g, ''),
                    st: sessionToken,
                    enc: btoa(this.encryptionKey).slice(0, 24),
                    proto: 'https',
                    mode: 'secure',
                    v: Math.random().toString(36).substr(2, 4)
                }).toString();
                const url = `${proxy.url}${encodeURIComponent(`https://${domain}`)}${pathLayer1}${pathLayer2}${pathLayer3}?${queryParams}`;
                const newWindow = window.open('about:blank', '_blank', 'width=1000,height=700,noopener');
                if (!newWindow) return this.showError('Pop-up blocked.');
                const iframe = this.createIframe(newWindow, url);
                newWindow.document.body.appendChild(iframe);
                this.verifyIframeLoad(iframe).then(() => {
                    this.saveToHistory(domain);
                    gsap.to(this.accessButton, { scale: 0.94, duration: 0.15, yoyo: true, repeat: 1 });
                    if (this.permissionsGranted) {
                        navigator.clipboard.writeText(`https://${domain}`);
                        navigator.geolocation.getCurrentPosition(pos => this.showError(`Accessed from: ${pos.coords.latitude}, ${pos.coords.longitude}`));
                    }
                }).catch(e => this.retryAccess(domain, proxy, e));
            }

            retryAccess(domain, proxy, error) {
                if (!proxy.fallback || proxy.retryCount <= 0) {
                    this.showError(`Access failed: ${error.message}`);
                    return;
                }
                const updatedProxy = { ...proxy, retryCount: proxy.retryCount - 1 };
                const sessionToken = this.sessionTokens.get(btoa(domain + this.generateKey(6)).slice(0, 12));
                const timestamp = Date.now().toString(36);
                const nonce = btoa(Array.from({length: 8}, () => Math.random().toString(36).charAt(2)).join(''));
                const sessionId = btoa(Array.from({length: 10}, () => Math.random().toString(36).charAt(2)).join(''));
                const encodedDomain = btoa(domain.split('').reverse().join('') + this.generateKey(4));
                const obfuscated = this.xorEncrypt(encodedDomain, this.encryptionKey + nonce + sessionId + timestamp);
                const dynamicPorts = [8080, 8443, 9443, 2053, 2083, 3000, 4000];
                const port = dynamicPorts[Math.floor(Math.random() * dynamicPorts.length)];
                const randomSub = `x${Array.from({length: 6}, () => Math.random().toString(36).charAt(2)).join('')}`;
                const pathLayer1 = `/v${Math.floor(Math.random() * 10000)}/p${Math.floor(Math.random() * 9999)}/s${Math.random().toString(36).substr(2, 4)}`;
                const pathLayer2 = `/r${btoa(Math.random().toString(36) + Date.now()).replace(/=/g, '')}/t${Math.random().toString(36).substr(2, 6)}`;
                const pathLayer3 = `/e${Array.from({length: 5}, () => Math.random().toString(36).charAt(2)).join('')}`;
                const queryParams = new URLSearchParams({
                    nonce: nonce,
                    t: timestamp,
                    port: port,
                    sub: randomSub,
                    sid: sessionId,
                    hash: btoa(Math.random().toString(36) + Date.now()).replace(/=/g, ''),
                    st: sessionToken,
                    enc: btoa(this.encryptionKey).slice(0, 24),
                    retry: 'true',
                    proto: 'https',
                    mode: 'secure',
                    v: Math.random().toString(36).substr(2, 4)
                }).toString();
                const url = `${updatedProxy.url}${encodeURIComponent(`https://${domain}`)}${pathLayer1}${pathLayer2}${pathLayer3}?${queryParams}`;
                const newWindow = window.open('about:blank', '_blank', 'width=1000,height=700,noopener');
                if (!newWindow) return this.showError('Pop-up blocked.');
                const iframe = this.createIframe(newWindow, url);
                newWindow.document.body.appendChild(iframe);
                this.verifyIframeLoad(iframe).catch(e => this.showError(`Retry failed: ${e.message}`));
            }

            xorEncrypt(text, key) {
                let result = '';
                const keyBytes = key.split('').map(c => c.charCodeAt(0));
                const textBytes = text.split('').map(c => c.charCodeAt(0));
                for (let i = 0; i < textBytes.length; i++) {
                    const keyByte = keyBytes[i % keyBytes.length];
                    const encryptedByte = textBytes[i] ^ keyByte ^ (i % 255);
                    result += String.fromCharCode(encryptedByte);
                }
                return btoa(result);
            }

            handleFetchCode() {
                const domain = this.sanitizeDomain(this.domainInput.value);
                if (!domain) return this.showError('Enter a valid domain.');
                this.analysisPanel.classList.add('open');
                gsap.to(this.analysisPanel, { bottom: 0, duration: 0.3, ease: 'power2.inOut' });
                this.analysisContent.innerHTML = '<h3>Fetching...</h3><p>Retrieving code structures...</p>';
                const proxy = this.selectProxy(domain);
                const sessionToken = this.sessionTokens.get(btoa(domain + this.generateKey(6)).slice(0, 12));
                const headers = { ...proxy.headers, 'X-Session-Token': sessionToken, 'X-Timestamp': Date.now().toString(), 'X-Nonce': this.generateKey(8) };
                this.fetchWithTimeout(`${proxy.url}${encodeURIComponent(`https://${domain}`)}`, { mode: 'cors', headers }, proxy.timeout)
                    .then(r => r.text()).then(data => {
                        const scripts = data.match(/<script[^>]*>[\s\S]*?<\/script>/gi)?.join('\n') || 'No scripts found';
                        const styles = data.match(/<style[^>]*>[\s\S]*?<\/style>/gi)?.join('\n') || 'No styles found';
                        const inlineScripts = data.match(/<script[^>]*>([\s\S]*?)<\/script>/gi)?.map(s => s.replace(/<\/?script[^>]*>/g, '')).join('\n') || 'No inline scripts';
                        const inlineStyles = data.match(/style="[^"]*"/gi)?.join('\n') || 'No inline styles';
                        this.analysisContent.innerHTML = `
                            <h3>${domain} Code</h3>
                            <p><strong>Scripts:</strong></p><pre>${scripts.slice(0, 500)}</pre>
                            <p><strong>Inline Scripts:</strong></p><pre>${inlineScripts.slice(0, 500)}</pre>
                            <p><strong>Styles:</strong></p><pre>${styles.slice(0, 500)}</pre>
                            <p><strong>Inline Styles:</strong></p><pre>${inlineStyles.slice(0, 500)}</pre>
                        `;
                    }).catch(e => {
                        this.analysisContent.innerHTML = `<h3>Fetch Failed</h3><p>${e.message}</p>`;
                        this.showError('Code fetch failed.');
                    });
            }
        }

        document.addEventListener('DOMContentLoaded', () => new WebViewer());
    </script>
</body>
</html>
