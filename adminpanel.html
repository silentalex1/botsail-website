<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Discord Bot Admin Panel</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <link rel="stylesheet" href="adminpanel.css">
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
</head>
<body class="bg-gray-900 min-h-screen flex flex-col items-center justify-center">
  <div id="root" class="w-full max-w-3xl mx-auto p-4"></div>
  <script type="text/babel">
    const { useState, useEffect } = React;
    const API_URL = 'http://localhost:8000';

    function Login({ onLogin }) {
      const [userId, setUserId] = useState('');
      const [error, setError] = useState('');
      const handleSubmit = e => {
        e.preventDefault();
        if (!userId.trim()) {
          setError('User ID required');
          return;
        }
        setError('');
        onLogin(userId.trim());
      };
      return (
        <form onSubmit={handleSubmit} className="bg-gray-800 rounded-lg p-6 shadow-md w-full max-w-sm mx-auto mt-12">
          <h2 className="text-2xl font-bold text-white mb-4 text-center">Admin Login</h2>
          <input
            className="w-full p-2 rounded bg-gray-700 text-white mb-2 focus:outline-none focus:ring-2 focus:ring-blue-400"
            placeholder="Enter your user ID"
            value={userId}
            onChange={e => setUserId(e.target.value)}
            autoFocus
          />
          {error && <div className="text-red-400 text-sm mb-2">{error}</div>}
          <button className="w-full bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 rounded transition">Login</button>
        </form>
      );
    }

    function BotList({ bots, onStop, onDelete, userId, loading }) {
      if (loading) return <div className="text-white text-center py-8">Loading bots...</div>;
      if (!bots.length) return <div className="text-gray-400 text-center py-8">No bots found.</div>;
      return (
        <div className="space-y-4">
          {bots.map(bot => (
            <div key={bot.bot_id} className="flex flex-col md:flex-row items-center justify-between bg-gray-800 rounded-lg p-4 shadow">
              <div className="flex-1 min-w-0">
                <div className="text-lg font-semibold text-white truncate">{bot.bot_name}</div>
                <div className="text-xs text-gray-400 truncate">ID: {bot.bot_id}</div>
                <div className={
                  bot.status === 'running' ? 'text-green-400' : 'text-red-400'
                }>
                  {bot.status === 'running' ? 'Running' : 'Stopped'}
                </div>
              </div>
              <div className="flex space-x-2 mt-2 md:mt-0">
                <button
                  className="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded font-semibold transition"
                  onClick={() => onStop(bot.bot_id)}
                  disabled={bot.status !== 'running'}
                >
                  Stop
                </button>
                <button
                  className="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded font-semibold transition"
                  onClick={() => onDelete(bot.bot_id)}
                >
                  Delete
                </button>
              </div>
            </div>
          ))}
        </div>
      );
    }

    function UploadForm({ userId, onUpload, uploading }) {
      const [botName, setBotName] = useState('');
      const [botToken, setBotToken] = useState('');
      const [file, setFile] = useState(null);
      const [error, setError] = useState('');
      const handleSubmit = async e => {
        e.preventDefault();
        if (!botName.trim() || !botToken.trim() || !file) {
          setError('All fields required');
          return;
        }
        if (!file.name.endsWith('.py')) {
          setError('Only .py files allowed');
          return;
        }
        setError('');
        onUpload({ botName: botName.trim(), botToken: botToken.trim(), file });
      };
      return (
        <form onSubmit={handleSubmit} className="bg-gray-800 rounded-lg p-6 shadow-md w-full max-w-lg mx-auto mt-8">
          <h2 className="text-xl font-bold text-white mb-4">Upload New Bot</h2>
          <input
            className="w-full p-2 rounded bg-gray-700 text-white mb-2 focus:outline-none focus:ring-2 focus:ring-blue-400"
            placeholder="Bot Name"
            value={botName}
            onChange={e => setBotName(e.target.value)}
            maxLength={32}
          />
          <input
            className="w-full p-2 rounded bg-gray-700 text-white mb-2 focus:outline-none focus:ring-2 focus:ring-blue-400"
            placeholder="Bot Token"
            value={botToken}
            onChange={e => setBotToken(e.target.value)}
            type="password"
            maxLength={80}
            autoComplete="off"
          />
          <input
            className="w-full p-2 rounded bg-gray-700 text-white mb-2 focus:outline-none focus:ring-2 focus:ring-blue-400"
            type="file"
            accept=".py"
            onChange={e => setFile(e.target.files[0])}
          />
          {error && <div className="text-red-400 text-sm mb-2">{error}</div>}
          <button
            className="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-2 rounded transition"
            disabled={uploading}
          >
            {uploading ? 'Uploading...' : 'Upload & Start Bot'}
          </button>
        </form>
      );
    }

    function Dashboard({ userId, onLogout }) {
      const [bots, setBots] = useState([]);
      const [loading, setLoading] = useState(true);
      const [uploading, setUploading] = useState(false);
      const [error, setError] = useState('');
      const [success, setSuccess] = useState('');
      const fetchBots = async () => {
        setLoading(true);
        setError('');
        try {
          const res = await axios.get(`${API_URL}/list_bots/`, { params: { user_id: userId } });
          setBots(res.data.bots || []);
        } catch (err) {
          setError('Failed to fetch bots.');
        }
        setLoading(false);
      };
      useEffect(() => { fetchBots(); }, [userId]);
      const handleUpload = async ({ botName, botToken, file }) => {
        setUploading(true);
        setError('');
        setSuccess('');
        try {
          const formData = new FormData();
          formData.append('user_id', userId);
          formData.append('bot_name', botName);
          formData.append('bot_token', botToken);
          formData.append('bot_code', file);
          await axios.post(`${API_URL}/upload_bot/`, formData, {
            headers: { 'Content-Type': 'multipart/form-data' }
          });
          setSuccess('Bot uploaded and started.');
          fetchBots();
        } catch (err) {
          setError(err.response?.data?.detail || 'Upload failed.');
        }
        setUploading(false);
      };
      const handleStop = async (botId) => {
        if (!window.confirm('Stop this bot?')) return;
        setError('');
        setSuccess('');
        try {
          await axios.post(`${API_URL}/stop_bot/`, { user_id: userId, bot_id: botId });
          setSuccess('Bot stopped.');
          fetchBots();
        } catch (err) {
          setError(err.response?.data?.detail || 'Failed to stop bot.');
        }
      };
      const handleDelete = async (botId) => {
        if (!window.confirm('Delete this bot? This cannot be undone.')) return;
        setError('');
        setSuccess('');
        try {
          await axios.post(`${API_URL}/delete_bot/`, { user_id: userId, bot_id: botId });
          setSuccess('Bot deleted.');
          fetchBots();
        } catch (err) {
          setError(err.response?.data?.detail || 'Failed to delete bot.');
        }
      };
      return (
        <div className="space-y-8">
          <div className="flex items-center justify-between">
            <h1 className="text-3xl font-bold text-white">Bot Dashboard</h1>
            <button onClick={onLogout} className="bg-gray-700 hover:bg-gray-600 text-white px-4 py-2 rounded font-semibold transition">Logout</button>
          </div>
          {error && <div className="bg-red-700 text-white rounded p-2 mb-2">{error}</div>}
          {success && <div className="bg-green-700 text-white rounded p-2 mb-2">{success}</div>}
          <UploadForm userId={userId} onUpload={handleUpload} uploading={uploading} />
          <div>
            <h2 className="text-xl font-bold text-white mb-2">Your Bots</h2>
            <BotList bots={bots} onStop={handleStop} onDelete={handleDelete} userId={userId} loading={loading} />
          </div>
        </div>
      );
    }

    function App() {
      const [userId, setUserId] = useState(localStorage.getItem('user_id') || '');
      useEffect(() => {
        if (userId) localStorage.setItem('user_id', userId);
      }, [userId]);
      if (!userId) return <Login onLogin={setUserId} />;
      return <Dashboard userId={userId} onLogout={() => { setUserId(''); localStorage.removeItem('user_id'); }} />;
    }

    ReactDOM.render(<App />, document.getElementById('root'));
  </script>
  <script src="https://unpkg.com/react@17/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@17/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
</body>
</html>
